<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content=' 近期查看有请求下游系统超时,按百分比的话是0.8%的样子,但是每天量很大,超时总数不到1亿次,如果这个可以优化一点,提升巨大的\n1.整体的探索过程 目前只知道最终结果是超时,但是是不是哪里代码写的有问题从而导致的超时,还需要去定位\n1.1初步定为问题 首先记录两个时间,第一个是请求一进来一直到拼接发送请求的位置这段代码的,第二个是拼接请求一直到Response(或者超时了)这段代码的时间\n超时情况:\n不超时情况:\n从图上来看,不管是超时和不超时都第一个时间都不长,所以是拼接请求到接受Response的时候引起的超时\n1.2更细化的定位问题 现在知道是和发送请求有关系了,那么应该对于这部分代码增加详细的记录,来分析问题\nOkHttp监控与调优查资料的时候看到这个文章写的不错\n经过一番查找资料,okhttp有一个EventListener,可以记录发送请求的各个步骤的时间\n于是就有了下边的代码\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 public class PrintingEventListener extends EventListener { @Override public void requestBodyEnd(@NotNull Call call, long byteCount) { printEvent("requestBodyEnd"); } @Override public void requestBodyStart(@NotNull Call call) { printEvent("requestBodyStart"); } @Override public void responseBodyEnd(@NotNull Call call, long byteCount) { printEvent("responseBodyEnd"); } @Override public void responseBodyStart(@NotNull Call call) { printEvent("responseBodyStart"); } @Override public void responseHeadersEnd(@NotNull Call call, @NotNull Response response) { printEvent("responseHeadersEnd"); } @Override public void responseHeadersStart(@NotNull Call call) { printEvent("responseHeadersStart"); } public static final Factory FACTORY = new Factory() { @Override public EventListener create(Call call) { //唯一标识 String randAllString = Format.getRandAllString(10); Random random = new Random(randAllString.hashCode()); double nextDouble = random.nextDouble(); //是tanx 与 10%的概率 if(call.request().url().toString().equals("xxx") && nextDouble * 100 <= 10){ InitServlet.okhttpTimeLog.plus(randAllString,"startSend",0L,""); //System.out.printf("%s %s%n", randAllString, call.request().url()); return new PrintingEventListener(randAllString, System.nanoTime()); }else{ return EventListener.NONE; } } }; final String callId; final long callStartNanos; public PrintingEventListener(String callId, long callStartNanos) { this.callId = callId; this.callStartNanos = callStartNanos; } private void printEvent(String name) { long elapsedNanos = System.nanoTime() - callStartNanos; InitServlet.okhttpTimeLog.plus(callId,name,elapsedNanos / 1000000L,""); //System.out.printf("%s %.0fms %s%n", callId, elapsedNanos / 1000000d, name); } private void printEvent(String name,IOException ioe){ long elapsedNanos = System.nanoTime() - callStartNanos; InitServlet.okhttpTimeLog.plus(callId,name,elapsedNanos / 1000000L,ioe.getMessage()); //System.out.printf("%s %.0fms %s %s%n", callId, elapsedNanos / 1000000d, name,ioe.getMessage()); } @Override public void callStart(Call call) { printEvent("callStart"); } @Override public void dnsStart(Call call, String domainName) { printEvent("dnsStart"); } @Override public void dnsEnd(Call call, String domainName, List<InetAddress> inetAddressList) { printEvent("dnsEnd"); } @Override public void connectStart(Call call, InetSocketAddress inetSocketAddress, Proxy proxy) { printEvent("connectStart"); } @Override public void secureConnectStart(Call call) { printEvent("secureConnectStart"); } @Override public void secureConnectEnd(Call call, @Nullable Handshake handshake) { printEvent("secureConnectEnd"); } @Override public void connectEnd(Call call, InetSocketAddress inetSocketAddress, Proxy proxy, @Nullable Protocol protocol) { printEvent("connectEnd"); } @Override public void connectFailed(Call call, InetSocketAddress inetSocketAddress, Proxy proxy, @Nullable Protocol protocol, IOException ioe) { printEvent("connectFailed"); } @Override public void connectionAcquired(Call call, Connection connection) { printEvent("connectionAcquired"); } @Override public void requestHeadersStart(Call call) { printEvent("requestHeadersStart"); } @Override public void requestHeadersEnd(Call call, Request request) { printEvent("requestHeadersEnd"); } @Override public void connectionReleased(Call call, Connection connection) { printEvent("connectionReleased"); } @Override public void requestFailed(Call call, IOException ioe) { printEvent("requestFailed",ioe); } @Override public void responseFailed(Call call, IOException ioe) { printEvent("responseFailed",ioe); } @Override public void callFailed(Call call, IOException ioe) { printEvent("callFailed",ioe); } @Override public void callEnd(Call call) { printEvent("callEnd"); } } 这个是记录的结果,这里只放一条数据了,可以明显看出来仅仅是等待Response的时候超时\n'><title>OkHttp优化过程记录</title>
<link rel=canonical href=https://chenchenfang.github.io/p/okhttp%E4%BC%98%E5%8C%96%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/><link rel=stylesheet href=/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css><meta property='og:title' content="OkHttp优化过程记录"><meta property='og:description' content=' 近期查看有请求下游系统超时,按百分比的话是0.8%的样子,但是每天量很大,超时总数不到1亿次,如果这个可以优化一点,提升巨大的\n1.整体的探索过程 目前只知道最终结果是超时,但是是不是哪里代码写的有问题从而导致的超时,还需要去定位\n1.1初步定为问题 首先记录两个时间,第一个是请求一进来一直到拼接发送请求的位置这段代码的,第二个是拼接请求一直到Response(或者超时了)这段代码的时间\n超时情况:\n不超时情况:\n从图上来看,不管是超时和不超时都第一个时间都不长,所以是拼接请求到接受Response的时候引起的超时\n1.2更细化的定位问题 现在知道是和发送请求有关系了,那么应该对于这部分代码增加详细的记录,来分析问题\nOkHttp监控与调优查资料的时候看到这个文章写的不错\n经过一番查找资料,okhttp有一个EventListener,可以记录发送请求的各个步骤的时间\n于是就有了下边的代码\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 public class PrintingEventListener extends EventListener { @Override public void requestBodyEnd(@NotNull Call call, long byteCount) { printEvent("requestBodyEnd"); } @Override public void requestBodyStart(@NotNull Call call) { printEvent("requestBodyStart"); } @Override public void responseBodyEnd(@NotNull Call call, long byteCount) { printEvent("responseBodyEnd"); } @Override public void responseBodyStart(@NotNull Call call) { printEvent("responseBodyStart"); } @Override public void responseHeadersEnd(@NotNull Call call, @NotNull Response response) { printEvent("responseHeadersEnd"); } @Override public void responseHeadersStart(@NotNull Call call) { printEvent("responseHeadersStart"); } public static final Factory FACTORY = new Factory() { @Override public EventListener create(Call call) { //唯一标识 String randAllString = Format.getRandAllString(10); Random random = new Random(randAllString.hashCode()); double nextDouble = random.nextDouble(); //是tanx 与 10%的概率 if(call.request().url().toString().equals("xxx") && nextDouble * 100 <= 10){ InitServlet.okhttpTimeLog.plus(randAllString,"startSend",0L,""); //System.out.printf("%s %s%n", randAllString, call.request().url()); return new PrintingEventListener(randAllString, System.nanoTime()); }else{ return EventListener.NONE; } } }; final String callId; final long callStartNanos; public PrintingEventListener(String callId, long callStartNanos) { this.callId = callId; this.callStartNanos = callStartNanos; } private void printEvent(String name) { long elapsedNanos = System.nanoTime() - callStartNanos; InitServlet.okhttpTimeLog.plus(callId,name,elapsedNanos / 1000000L,""); //System.out.printf("%s %.0fms %s%n", callId, elapsedNanos / 1000000d, name); } private void printEvent(String name,IOException ioe){ long elapsedNanos = System.nanoTime() - callStartNanos; InitServlet.okhttpTimeLog.plus(callId,name,elapsedNanos / 1000000L,ioe.getMessage()); //System.out.printf("%s %.0fms %s %s%n", callId, elapsedNanos / 1000000d, name,ioe.getMessage()); } @Override public void callStart(Call call) { printEvent("callStart"); } @Override public void dnsStart(Call call, String domainName) { printEvent("dnsStart"); } @Override public void dnsEnd(Call call, String domainName, List<InetAddress> inetAddressList) { printEvent("dnsEnd"); } @Override public void connectStart(Call call, InetSocketAddress inetSocketAddress, Proxy proxy) { printEvent("connectStart"); } @Override public void secureConnectStart(Call call) { printEvent("secureConnectStart"); } @Override public void secureConnectEnd(Call call, @Nullable Handshake handshake) { printEvent("secureConnectEnd"); } @Override public void connectEnd(Call call, InetSocketAddress inetSocketAddress, Proxy proxy, @Nullable Protocol protocol) { printEvent("connectEnd"); } @Override public void connectFailed(Call call, InetSocketAddress inetSocketAddress, Proxy proxy, @Nullable Protocol protocol, IOException ioe) { printEvent("connectFailed"); } @Override public void connectionAcquired(Call call, Connection connection) { printEvent("connectionAcquired"); } @Override public void requestHeadersStart(Call call) { printEvent("requestHeadersStart"); } @Override public void requestHeadersEnd(Call call, Request request) { printEvent("requestHeadersEnd"); } @Override public void connectionReleased(Call call, Connection connection) { printEvent("connectionReleased"); } @Override public void requestFailed(Call call, IOException ioe) { printEvent("requestFailed",ioe); } @Override public void responseFailed(Call call, IOException ioe) { printEvent("responseFailed",ioe); } @Override public void callFailed(Call call, IOException ioe) { printEvent("callFailed",ioe); } @Override public void callEnd(Call call) { printEvent("callEnd"); } } 这个是记录的结果,这里只放一条数据了,可以明显看出来仅仅是等待Response的时候超时\n'><meta property='og:url' content='https://chenchenfang.github.io/p/okhttp%E4%BC%98%E5%8C%96%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/'><meta property='og:site_name' content='fang7个人博客'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2023-10-14T10:06:00+08:00'><meta property='article:modified_time' content='2023-10-14T10:06:00+08:00'><meta name=twitter:title content="OkHttp优化过程记录"><meta name=twitter:description content=' 近期查看有请求下游系统超时,按百分比的话是0.8%的样子,但是每天量很大,超时总数不到1亿次,如果这个可以优化一点,提升巨大的\n1.整体的探索过程 目前只知道最终结果是超时,但是是不是哪里代码写的有问题从而导致的超时,还需要去定位\n1.1初步定为问题 首先记录两个时间,第一个是请求一进来一直到拼接发送请求的位置这段代码的,第二个是拼接请求一直到Response(或者超时了)这段代码的时间\n超时情况:\n不超时情况:\n从图上来看,不管是超时和不超时都第一个时间都不长,所以是拼接请求到接受Response的时候引起的超时\n1.2更细化的定位问题 现在知道是和发送请求有关系了,那么应该对于这部分代码增加详细的记录,来分析问题\nOkHttp监控与调优查资料的时候看到这个文章写的不错\n经过一番查找资料,okhttp有一个EventListener,可以记录发送请求的各个步骤的时间\n于是就有了下边的代码\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 public class PrintingEventListener extends EventListener { @Override public void requestBodyEnd(@NotNull Call call, long byteCount) { printEvent("requestBodyEnd"); } @Override public void requestBodyStart(@NotNull Call call) { printEvent("requestBodyStart"); } @Override public void responseBodyEnd(@NotNull Call call, long byteCount) { printEvent("responseBodyEnd"); } @Override public void responseBodyStart(@NotNull Call call) { printEvent("responseBodyStart"); } @Override public void responseHeadersEnd(@NotNull Call call, @NotNull Response response) { printEvent("responseHeadersEnd"); } @Override public void responseHeadersStart(@NotNull Call call) { printEvent("responseHeadersStart"); } public static final Factory FACTORY = new Factory() { @Override public EventListener create(Call call) { //唯一标识 String randAllString = Format.getRandAllString(10); Random random = new Random(randAllString.hashCode()); double nextDouble = random.nextDouble(); //是tanx 与 10%的概率 if(call.request().url().toString().equals("xxx") && nextDouble * 100 <= 10){ InitServlet.okhttpTimeLog.plus(randAllString,"startSend",0L,""); //System.out.printf("%s %s%n", randAllString, call.request().url()); return new PrintingEventListener(randAllString, System.nanoTime()); }else{ return EventListener.NONE; } } }; final String callId; final long callStartNanos; public PrintingEventListener(String callId, long callStartNanos) { this.callId = callId; this.callStartNanos = callStartNanos; } private void printEvent(String name) { long elapsedNanos = System.nanoTime() - callStartNanos; InitServlet.okhttpTimeLog.plus(callId,name,elapsedNanos / 1000000L,""); //System.out.printf("%s %.0fms %s%n", callId, elapsedNanos / 1000000d, name); } private void printEvent(String name,IOException ioe){ long elapsedNanos = System.nanoTime() - callStartNanos; InitServlet.okhttpTimeLog.plus(callId,name,elapsedNanos / 1000000L,ioe.getMessage()); //System.out.printf("%s %.0fms %s %s%n", callId, elapsedNanos / 1000000d, name,ioe.getMessage()); } @Override public void callStart(Call call) { printEvent("callStart"); } @Override public void dnsStart(Call call, String domainName) { printEvent("dnsStart"); } @Override public void dnsEnd(Call call, String domainName, List<InetAddress> inetAddressList) { printEvent("dnsEnd"); } @Override public void connectStart(Call call, InetSocketAddress inetSocketAddress, Proxy proxy) { printEvent("connectStart"); } @Override public void secureConnectStart(Call call) { printEvent("secureConnectStart"); } @Override public void secureConnectEnd(Call call, @Nullable Handshake handshake) { printEvent("secureConnectEnd"); } @Override public void connectEnd(Call call, InetSocketAddress inetSocketAddress, Proxy proxy, @Nullable Protocol protocol) { printEvent("connectEnd"); } @Override public void connectFailed(Call call, InetSocketAddress inetSocketAddress, Proxy proxy, @Nullable Protocol protocol, IOException ioe) { printEvent("connectFailed"); } @Override public void connectionAcquired(Call call, Connection connection) { printEvent("connectionAcquired"); } @Override public void requestHeadersStart(Call call) { printEvent("requestHeadersStart"); } @Override public void requestHeadersEnd(Call call, Request request) { printEvent("requestHeadersEnd"); } @Override public void connectionReleased(Call call, Connection connection) { printEvent("connectionReleased"); } @Override public void requestFailed(Call call, IOException ioe) { printEvent("requestFailed",ioe); } @Override public void responseFailed(Call call, IOException ioe) { printEvent("responseFailed",ioe); } @Override public void callFailed(Call call, IOException ioe) { printEvent("callFailed",ioe); } @Override public void callEnd(Call call) { printEvent("callEnd"); } } 这个是记录的结果,这里只放一条数据了,可以明显看出来仅仅是等待Response的时候超时\n'><link rel="shortcut icon" href=/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu9005595318015309411.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🍥</span></figure><div class=site-meta><h1 class=site-name><a href=/>fang7个人博客</a></h1><h2 class=site-description>实用技巧与技术解决方案分享.</h2></div></header><ol class=menu-social><li><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter rel=me><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#11初步定为问题>1.1初步定为问题</a></li><li><a href=#12更细化的定位问题>1.2更细化的定位问题</a></li></ol><ol><li><a href=#21okhttp各种参数的检查>2.1okhttp各种参数的检查</a></li><li><a href=#22回归代码>2.2回归代码</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/p/okhttp%E4%BC%98%E5%8C%96%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/>OkHttp优化过程记录</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Oct 14, 2023</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>3 minute read</time></div></footer></div></header><section class=article-content><blockquote><p>近期查看有请求下游系统超时,按百分比的话是0.8%的样子,但是每天量很大,超时总数不到1亿次,如果这个可以优化一点,提升巨大的</p></blockquote><h1 id=1整体的探索过程>1.整体的探索过程</h1><blockquote><p>目前只知道最终结果是超时,但是是不是哪里代码写的有问题从而导致的超时,还需要去定位</p></blockquote><h2 id=11初步定为问题>1.1初步定为问题</h2><p>首先记录两个时间,第一个是请求一进来一直到拼接发送请求的位置这段代码的,第二个是拼接请求一直到Response(或者超时了)这段代码的时间<br>超时情况:<br><img src=/p/okhttp%E4%BC%98%E5%8C%96%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/731e42fcb6ab158c698b819c85ddddb3ed95365b.png width=1622 height=962 srcset="/p/okhttp%E4%BC%98%E5%8C%96%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/731e42fcb6ab158c698b819c85ddddb3ed95365b_hu959709198380300150.png 480w, /p/okhttp%E4%BC%98%E5%8C%96%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/731e42fcb6ab158c698b819c85ddddb3ed95365b_hu1282212480590999554.png 1024w" loading=lazy alt=image-1697245681908 class=gallery-image data-flex-grow=168 data-flex-basis=404px>
不超时情况:<br><img src=/p/okhttp%E4%BC%98%E5%8C%96%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/4a003a4dca4afea5db00df10c5848a7bd241698d.png width=1586 height=916 srcset="/p/okhttp%E4%BC%98%E5%8C%96%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/4a003a4dca4afea5db00df10c5848a7bd241698d_hu14326980663132857269.png 480w, /p/okhttp%E4%BC%98%E5%8C%96%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/4a003a4dca4afea5db00df10c5848a7bd241698d_hu17658798224294194040.png 1024w" loading=lazy alt=image-1697245800201 class=gallery-image data-flex-grow=173 data-flex-basis=415px>
从图上来看,不管是超时和不超时都第一个时间都不长,所以是拼接请求到接受Response的时候引起的超时</p><h2 id=12更细化的定位问题>1.2更细化的定位问题</h2><blockquote><p>现在知道是和发送请求有关系了,那么应该对于这部分代码增加详细的记录,来分析问题</p></blockquote><p><a class=link href=https://zhaoxiaofa.com/2021/09/03/OkHttp%E7%9B%91%E6%8E%A7%E4%B8%8E%E8%B0%83%E4%BC%98/ target=_blank rel=noopener>OkHttp监控与调优</a>查资料的时候看到这个文章写的不错<br>经过一番查找资料,okhttp有一个EventListener,可以记录发送请求的各个步骤的时间<br>于是就有了下边的代码</p><div class="highlight java hljs"><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>public</span> <span class=k>class</span> <span class=n>PrintingEventListener</span> <span class=k>extends</span> <span class=n>EventListener</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>requestBodyEnd</span><span class=p>(</span><span class=err>@</span><span class=n>NotNull</span> <span class=n>Call</span> <span class=n>call</span><span class=p>,</span> <span class=n>long</span> <span class=n>byteCount</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printEvent</span><span class=p>(</span><span class=s2>&#34;requestBodyEnd&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>requestBodyStart</span><span class=p>(</span><span class=err>@</span><span class=n>NotNull</span> <span class=n>Call</span> <span class=n>call</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printEvent</span><span class=p>(</span><span class=s2>&#34;requestBodyStart&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>responseBodyEnd</span><span class=p>(</span><span class=err>@</span><span class=n>NotNull</span> <span class=n>Call</span> <span class=n>call</span><span class=p>,</span> <span class=n>long</span> <span class=n>byteCount</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printEvent</span><span class=p>(</span><span class=s2>&#34;responseBodyEnd&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>responseBodyStart</span><span class=p>(</span><span class=err>@</span><span class=n>NotNull</span> <span class=n>Call</span> <span class=n>call</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printEvent</span><span class=p>(</span><span class=s2>&#34;responseBodyStart&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>responseHeadersEnd</span><span class=p>(</span><span class=err>@</span><span class=n>NotNull</span> <span class=n>Call</span> <span class=n>call</span><span class=p>,</span> <span class=err>@</span><span class=n>NotNull</span> <span class=n>Response</span> <span class=n>response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printEvent</span><span class=p>(</span><span class=s2>&#34;responseHeadersEnd&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>responseHeadersStart</span><span class=p>(</span><span class=err>@</span><span class=n>NotNull</span> <span class=n>Call</span> <span class=n>call</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printEvent</span><span class=p>(</span><span class=s2>&#34;responseHeadersStart&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=k>static</span> <span class=n>final</span> <span class=n>Factory</span> <span class=n>FACTORY</span> <span class=o>=</span> <span class=n>new</span> <span class=n>Factory</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=err>@</span><span class=n>Override</span> <span class=n>public</span> <span class=n>EventListener</span> <span class=n>create</span><span class=p>(</span><span class=n>Call</span> <span class=n>call</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=o>//</span><span class=err>唯一标识</span>
</span></span><span class=line><span class=cl>            <span class=ne>String</span> <span class=n>randAllString</span> <span class=o>=</span> <span class=n>Format</span><span class=o>.</span><span class=n>getRandAllString</span><span class=p>(</span><span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Random</span> <span class=n>random</span> <span class=o>=</span> <span class=n>new</span> <span class=n>Random</span><span class=p>(</span><span class=n>randAllString</span><span class=o>.</span><span class=n>hashCode</span><span class=p>());</span>
</span></span><span class=line><span class=cl>            <span class=n>double</span> <span class=n>nextDouble</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>nextDouble</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=o>//</span><span class=err>是</span><span class=n>tanx</span> <span class=err>与</span> <span class=mi>10</span><span class=o>%</span><span class=err>的概率</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=p>(</span><span class=n>call</span><span class=o>.</span><span class=n>request</span><span class=p>()</span><span class=o>.</span><span class=n>url</span><span class=p>()</span><span class=o>.</span><span class=n>toString</span><span class=p>()</span><span class=o>.</span><span class=n>equals</span><span class=p>(</span><span class=s2>&#34;xxx&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=o>&amp;&amp;</span> <span class=n>nextDouble</span> <span class=o>*</span> <span class=mi>100</span> <span class=o>&lt;=</span> <span class=mi>10</span><span class=p>){</span>
</span></span><span class=line><span class=cl>                <span class=n>InitServlet</span><span class=o>.</span><span class=n>okhttpTimeLog</span><span class=o>.</span><span class=n>plus</span><span class=p>(</span><span class=n>randAllString</span><span class=p>,</span><span class=s2>&#34;startSend&#34;</span><span class=p>,</span><span class=mi>0</span><span class=n>L</span><span class=p>,</span><span class=s2>&#34;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=o>//</span><span class=n>System</span><span class=o>.</span><span class=n>out</span><span class=o>.</span><span class=n>printf</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>%s</span><span class=s2> </span><span class=si>%s</span><span class=s2>%n&#34;</span><span class=p>,</span> <span class=n>randAllString</span><span class=p>,</span> <span class=n>call</span><span class=o>.</span><span class=n>request</span><span class=p>()</span><span class=o>.</span><span class=n>url</span><span class=p>());</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>new</span> <span class=n>PrintingEventListener</span><span class=p>(</span><span class=n>randAllString</span><span class=p>,</span> <span class=n>System</span><span class=o>.</span><span class=n>nanoTime</span><span class=p>());</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>EventListener</span><span class=o>.</span><span class=n>NONE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>final</span> <span class=ne>String</span> <span class=n>callId</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>final</span> <span class=n>long</span> <span class=n>callStartNanos</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>PrintingEventListener</span><span class=p>(</span><span class=ne>String</span> <span class=n>callId</span><span class=p>,</span> <span class=n>long</span> <span class=n>callStartNanos</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>this</span><span class=o>.</span><span class=n>callId</span> <span class=o>=</span> <span class=n>callId</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>this</span><span class=o>.</span><span class=n>callStartNanos</span> <span class=o>=</span> <span class=n>callStartNanos</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>private</span> <span class=n>void</span> <span class=n>printEvent</span><span class=p>(</span><span class=ne>String</span> <span class=n>name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>long</span> <span class=n>elapsedNanos</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=n>nanoTime</span><span class=p>()</span> <span class=o>-</span> <span class=n>callStartNanos</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>InitServlet</span><span class=o>.</span><span class=n>okhttpTimeLog</span><span class=o>.</span><span class=n>plus</span><span class=p>(</span><span class=n>callId</span><span class=p>,</span><span class=n>name</span><span class=p>,</span><span class=n>elapsedNanos</span> <span class=o>/</span> <span class=mi>1000000</span><span class=n>L</span><span class=p>,</span><span class=s2>&#34;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span><span class=n>System</span><span class=o>.</span><span class=n>out</span><span class=o>.</span><span class=n>printf</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>%s</span><span class=s2> </span><span class=si>%.0f</span><span class=s2>ms </span><span class=si>%s</span><span class=s2>%n&#34;</span><span class=p>,</span> <span class=n>callId</span><span class=p>,</span> <span class=n>elapsedNanos</span> <span class=o>/</span> <span class=mi>1000000</span><span class=n>d</span><span class=p>,</span> <span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>private</span> <span class=n>void</span> <span class=n>printEvent</span><span class=p>(</span><span class=ne>String</span> <span class=n>name</span><span class=p>,</span><span class=n>IOException</span> <span class=n>ioe</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=n>long</span> <span class=n>elapsedNanos</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=n>nanoTime</span><span class=p>()</span> <span class=o>-</span> <span class=n>callStartNanos</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>InitServlet</span><span class=o>.</span><span class=n>okhttpTimeLog</span><span class=o>.</span><span class=n>plus</span><span class=p>(</span><span class=n>callId</span><span class=p>,</span><span class=n>name</span><span class=p>,</span><span class=n>elapsedNanos</span> <span class=o>/</span> <span class=mi>1000000</span><span class=n>L</span><span class=p>,</span><span class=n>ioe</span><span class=o>.</span><span class=n>getMessage</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=o>//</span><span class=n>System</span><span class=o>.</span><span class=n>out</span><span class=o>.</span><span class=n>printf</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>%s</span><span class=s2> </span><span class=si>%.0f</span><span class=s2>ms </span><span class=si>%s</span><span class=s2> </span><span class=si>%s</span><span class=s2>%n&#34;</span><span class=p>,</span> <span class=n>callId</span><span class=p>,</span> <span class=n>elapsedNanos</span> <span class=o>/</span> <span class=mi>1000000</span><span class=n>d</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span><span class=n>ioe</span><span class=o>.</span><span class=n>getMessage</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>callStart</span><span class=p>(</span><span class=n>Call</span> <span class=n>call</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printEvent</span><span class=p>(</span><span class=s2>&#34;callStart&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>dnsStart</span><span class=p>(</span><span class=n>Call</span> <span class=n>call</span><span class=p>,</span> <span class=ne>String</span> <span class=n>domainName</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printEvent</span><span class=p>(</span><span class=s2>&#34;dnsStart&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>dnsEnd</span><span class=p>(</span><span class=n>Call</span> <span class=n>call</span><span class=p>,</span> <span class=ne>String</span> <span class=n>domainName</span><span class=p>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>InetAddress</span><span class=o>&gt;</span> <span class=n>inetAddressList</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printEvent</span><span class=p>(</span><span class=s2>&#34;dnsEnd&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>connectStart</span><span class=p>(</span><span class=n>Call</span> <span class=n>call</span><span class=p>,</span> <span class=n>InetSocketAddress</span> <span class=n>inetSocketAddress</span><span class=p>,</span> <span class=n>Proxy</span> <span class=n>proxy</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printEvent</span><span class=p>(</span><span class=s2>&#34;connectStart&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>secureConnectStart</span><span class=p>(</span><span class=n>Call</span> <span class=n>call</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printEvent</span><span class=p>(</span><span class=s2>&#34;secureConnectStart&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>secureConnectEnd</span><span class=p>(</span><span class=n>Call</span> <span class=n>call</span><span class=p>,</span> <span class=err>@</span><span class=n>Nullable</span> <span class=n>Handshake</span> <span class=n>handshake</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printEvent</span><span class=p>(</span><span class=s2>&#34;secureConnectEnd&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>connectEnd</span><span class=p>(</span><span class=n>Call</span> <span class=n>call</span><span class=p>,</span> <span class=n>InetSocketAddress</span> <span class=n>inetSocketAddress</span><span class=p>,</span> <span class=n>Proxy</span> <span class=n>proxy</span><span class=p>,</span> <span class=err>@</span><span class=n>Nullable</span> <span class=n>Protocol</span> <span class=n>protocol</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printEvent</span><span class=p>(</span><span class=s2>&#34;connectEnd&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>connectFailed</span><span class=p>(</span><span class=n>Call</span> <span class=n>call</span><span class=p>,</span> <span class=n>InetSocketAddress</span> <span class=n>inetSocketAddress</span><span class=p>,</span> <span class=n>Proxy</span> <span class=n>proxy</span><span class=p>,</span> <span class=err>@</span><span class=n>Nullable</span> <span class=n>Protocol</span> <span class=n>protocol</span><span class=p>,</span> <span class=n>IOException</span> <span class=n>ioe</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printEvent</span><span class=p>(</span><span class=s2>&#34;connectFailed&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>connectionAcquired</span><span class=p>(</span><span class=n>Call</span> <span class=n>call</span><span class=p>,</span> <span class=n>Connection</span> <span class=n>connection</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printEvent</span><span class=p>(</span><span class=s2>&#34;connectionAcquired&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>requestHeadersStart</span><span class=p>(</span><span class=n>Call</span> <span class=n>call</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printEvent</span><span class=p>(</span><span class=s2>&#34;requestHeadersStart&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>requestHeadersEnd</span><span class=p>(</span><span class=n>Call</span> <span class=n>call</span><span class=p>,</span> <span class=n>Request</span> <span class=n>request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printEvent</span><span class=p>(</span><span class=s2>&#34;requestHeadersEnd&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>connectionReleased</span><span class=p>(</span><span class=n>Call</span> <span class=n>call</span><span class=p>,</span> <span class=n>Connection</span> <span class=n>connection</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printEvent</span><span class=p>(</span><span class=s2>&#34;connectionReleased&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>requestFailed</span><span class=p>(</span><span class=n>Call</span> <span class=n>call</span><span class=p>,</span> <span class=n>IOException</span> <span class=n>ioe</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printEvent</span><span class=p>(</span><span class=s2>&#34;requestFailed&#34;</span><span class=p>,</span><span class=n>ioe</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>responseFailed</span><span class=p>(</span><span class=n>Call</span> <span class=n>call</span><span class=p>,</span> <span class=n>IOException</span> <span class=n>ioe</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printEvent</span><span class=p>(</span><span class=s2>&#34;responseFailed&#34;</span><span class=p>,</span><span class=n>ioe</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span>
</span></span><span class=line><span class=cl>    <span class=n>public</span> <span class=n>void</span> <span class=n>callFailed</span><span class=p>(</span><span class=n>Call</span> <span class=n>call</span><span class=p>,</span> <span class=n>IOException</span> <span class=n>ioe</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printEvent</span><span class=p>(</span><span class=s2>&#34;callFailed&#34;</span><span class=p>,</span><span class=n>ioe</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>Override</span> <span class=n>public</span> <span class=n>void</span> <span class=n>callEnd</span><span class=p>(</span><span class=n>Call</span> <span class=n>call</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printEvent</span><span class=p>(</span><span class=s2>&#34;callEnd&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这个是记录的结果,这里只放一条数据了,可以明显看出来仅仅是等待Response的时候超时<br><img src=/p/okhttp%E4%BC%98%E5%8C%96%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/5c354dbb64d42457b94bbc762023cb6ae3d85bde.png width=1594 height=734 srcset="/p/okhttp%E4%BC%98%E5%8C%96%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/5c354dbb64d42457b94bbc762023cb6ae3d85bde_hu8966688172176265007.png 480w, /p/okhttp%E4%BC%98%E5%8C%96%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/5c354dbb64d42457b94bbc762023cb6ae3d85bde_hu10377475572011981773.png 1024w" loading=lazy alt=image-1697247499791 class=gallery-image data-flex-grow=217 data-flex-basis=521px></p><h1 id=2寻求优化问题的方法>2.寻求优化问题的方法</h1><blockquote><p>这个问题的根本原因是下游响应时间长导致的,首先我们是不可能去干预下游系统的,那从我们自身来看,有哪些可以优化的地方呢?</p></blockquote><h2 id=21okhttp各种参数的检查>2.1okhttp各种参数的检查</h2><blockquote><p>最常见的就是参数优化,调整参数之前需要有相应的日志或者当前数据来支持,没有数据的调参都是瞎搞</p></blockquote><p>经过一番查找资料,收集了几个okhttp的参数,开始做监控</p><div class="highlight java hljs"><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>//新增监控发送给dsp的线程池
</span></span><span class=line><span class=cl>            val queuedCallsCount = Java_To_Dsp_Handle.OkHttpClientTool.dispatcher.queuedCallsCount()
</span></span><span class=line><span class=cl>            val runningCallsCount = Java_To_Dsp_Handle.OkHttpClientTool.dispatcher.runningCallsCount()
</span></span><span class=line><span class=cl>            val connectionCount = Java_To_Dsp_Handle.OkHttpClientTool.connectionPool.connectionCount()
</span></span><span class=line><span class=cl>            val idleConnectionCount = Java_To_Dsp_Handle.OkHttpClientTool.connectionPool.idleConnectionCount()
</span></span><span class=line><span class=cl>            out.println(&#34;准备好发送的请求:${queuedCallsCount},正在发送的请求:${runningCallsCount}\n&#34;)
</span></span><span class=line><span class=cl>            out.println(&#34;发送请求的线程池情况:${Java_To_Dsp_Handle.OkHttpClientTool.threadPool}\n&#34;)
</span></span><span class=line><span class=cl>            out.println(&#34;目前建立的连接数量:${connectionCount},空闲的连接数量:${idleConnectionCount}\n&#34;)
</span></span><span class=line><span class=cl>            //每个host的请求数
</span></span><span class=line><span class=cl>            out.println(Java_To_Dsp_Handle.OkHttpClientTool.hostRequestCounterInterceptor.printRequestCountForHost())
</span></span></code></pre></td></tr></table></div></div><p>以下是执行完之后的打印</p><div class="highlight hljs language-java"><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>准备好发送的请求:0,正在发送的请求:65
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>发送请求的线程池情况:java.util.concurrent.ThreadPoolExecutor@3dceaaa5[Running, pool size = 600, active threads = 66, queued tasks = 0, completed tasks = 44826120]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>目前建立的连接数量:316,空闲的连接数量:260
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>host:xxx  count:25
</span></span></code></pre></td></tr></table></div></div><p>分析打印的结果:</p><ol><li>准备好发送的请求如果有值的话,那么就可能发生等待,这里并没有</li><li>发送请求的线程池也没有满,也没有等待的任务,所以这个也没问题</li><li>再有就是空闲连接也没有达到设置的值,也没问题</li><li>最后一个是每个host最大并发数,也远低于设置的值</li></ol><p>这一顿操作下来,发现参数并没有问题</p><h2 id=22回归代码>2.2回归代码</h2><blockquote><p>一般来说,陈年旧代码有优化空间的概率是比较大的,于是抱着试一试的心态,通读了okhttp发送的相关代码,发现确实有提升空间</p></blockquote><p>OkHttpClient对象一般是不会创建很多个,所以之前老代码的逻辑是分成5个OkHttpClient对象,也就是5个梯度的等待时间<br>比如当前需要等待67毫秒,那么按照梯度会选择超时时间设置为50的OkHttpClient对象,那么这个期间会有17ms的时间损失<br>一顿查资料以及测试之后发现,OkHttpClient对象每个请求new一个是不合适的,new这个对象时间比较长,但是可以调用OkHttpClient对象的<code>okclient.newBuilder()</code>{.language-plaintext
.highlighter-rouge}方法重新设置超时时间,这种方式基本没有耗时</p><p>升级完成之后,Response的数量有所上涨,超时率数据目前还没出来,等出来了会补上,至此整个分析以及优化过程告一段落</p></section><footer class=article-footer><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hugo-theme-stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2024 fang7个人博客</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.29.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>